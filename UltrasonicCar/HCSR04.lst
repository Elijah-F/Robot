C51 COMPILER V9.01   HCSR04                                                                09/28/2019 21:24:15 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE HCSR04
OBJECT MODULE PLACED IN HCSR04.obj
COMPILER INVOKED BY: D:\SoftwareInstalled\keil4\C51\BIN\C51.EXE HCSR04\HCSR04.c BROWSE INCDIR(.\Delay;.\HCSR04;.\Motor;.
                    -\Uart) DEBUG OBJECTEXTEND PRINT(.\HCSR04.lst) OBJECT(HCSR04.obj)

line level    source

   1          
   2          
   3          
   4          
   5          /******************************************************************************
   6          ³¬Éù²¨É¨Ãè³ÌÐò:
   7                  ¶¨Ê±Æ÷0Ã¿10ms²úÉúÒ»´ÎÖÐ¶Ï,¸øTriqÒý½Å10usµÄ¸ßµçÆ½´¥·¢³¬Éù²¨(Ã¿´Î¶¨Ê±Æ÷0Ö»ÄÜ´¥·¢Ò»¸ö³¬Éù²¨,ËÄ¸ö³¬Éù²¨ÐèÒªËÄ
             -´Î¶¨Ê±Æ÷ÖÐ¶Ï)
   8                  ¼ì²âEcho(»òÃÅ³ö¶Ë)ÊÇ·ñÎª¸ßµçÆ½´Ó¶øÅÐ¶ÏÊÇ·ñ¼ì²âµ½ÎïÌå,Îª¼ì²âµ½Ö±½ÓÍË³ö,¼ì²âµ½ÁË¼ÇÂ¼´ËÊ±¶¨Ê±Æ÷µÄÖµ(ÉÏÉýÑØµÄ
             -Öµ),²¢¿ªÆôÍâ²¿ÖÐ¶Ï0
   9                  Èç¹û10msÄÚ´¥·¢ÁËÍâ²¿ÖÐ¶Ï0(10msÄÚÓöµ½ÏÂ½µÑØ),Ö´ÐÐÖÐ¶Ï·þÎñº¯Êý,¼ÇÂ¼ÏÂ½µÑØÊ±¶¨Ê±Æ÷µÄÖµ,Í¨¹ýÁ½´Î¶¨Ê±Æ÷Öµ×ö²îµ
             -Ãµ½¾àÀë
  10                  Èç¹û10msÄÚÃ»ÓÐ´¥·¢Íâ²¿ÖÐ¶Ï(Ã»ÓÐÏÂ½µÑØ,Ò»Ö±ÊÇ¸ßµçÆ½),ËµÃ÷¾àÀëÒÑ¾­³¬³ö¼ì²â×î´ó¾àÀë,½«distance[i]ÉèÖÃÎªÒç³öÖ
             -µ
  11          
  12                  ³¬Éù²¨µÄTriqÒý½ÅºÍEchoÒý½Å·Ö±ðÓëµ¥Æ¬»úIO¿ÚÁ¬½Ó,ËùÓÐEchoÒý½ÅÍ¨¹ýÒ»¸ö¶àÊäÈë»òÃÅ,Êä³öÓëP3^2ÏàÁ¬,´Ó¶øÊµÏÖÀûÓÃ
             -Ò»¸öÖÐ¶Ï½ÓÊÕ¶à¸ö³¬Éù²¨¡£
  13                  ÐèÒª×¢ÒâµÄÊÇ£ºµ±ÓÐÒ»¸ö³¬Éù²¨¼ì²âµ½µÄ¾àÀë¹ýÔ¶Ê±(¶¼ÂÖµ½¼ì²âÏÂÒ»¸ö³¬Éù²¨Ä£¿éÁËÕâ¸öÄ£¿é¸ßµçÆ½»¹Ã»½áÊø),´ËÊ±ÔÚ
             -»òÃÅµÄ×÷ÓÃÏÂP3^2Òý½ÅÒ»Ö±Îª¸ß
  14                  »áÓ°ÏìÆäËû³¬Éù²¨µÄÕý³£¹¤×÷(ÖÐ¶Ï²»ÄÜ´¥·¢,ÒòÎªÏÂ½µÑØ´¥·¢ÖÐ¶Ï),Òò´ËÃ¿´Î¿ªÆô³¬Éù²¨µÄÊ±ºòÐèÒªÅÐ¶ÏÒ»ÏÂÉÏÒ»´ÎµÄ³
             -¬Éù²¨EchoÒý½ÅÊÇ·ñÎª¸ß
  15                  ÊÇÔòÀ­µÍ,²¢ÇÒ¸øÆä¾àÀë¸³Òç³öÖµ(ËµÃ÷¾àÀëÌ«Ô¶³¬³ö¼ì²â·¶Î§)
  16          *******************************************************************************/
  17          
  18          
  19          
  20          #include "HCSR04.h"
  21          #include "intrins.h"
  22          #include "Motor.h"
  23          #include "uart.h"
  24          /*³¬Éù²¨TriqÒý½Å¶¨Òå,´¥·¢²â¾àÒý½Å*/
  25          sbit Triq1=P2^0;        //Ç°×ó
  26          sbit Triq2=P2^1;        //Ç°ÓÒ
  27          sbit Triq3=P2^2;        //ÖÐºó   
  28          sbit Triq4=P2^3;        //Ç°ÖÐ
  29          /*³¬Éù²¨EchoÒý½Å¶¨Òå*/
  30          sbit Echo1=P2^4;
  31          sbit Echo2=P2^5;
  32          sbit Echo3=P2^6;
  33          sbit Echo4=P2^7;
  34          
  35          sbit Echo=P3^2;         //»òÃÅÊä³ö¶ËÒý½Å¶¨Òå,¶ÔÓ¦Íâ²¿ÖÐ¶Ï0
  36          sbit LED=P1^7;          //´¥·¢ÖÐ¶Ï ¼ì²âµ½ÎïÌå×´Ì¬Ö¸Ê¾µÆ
  37          unsigned int Dis_H=0,Dis_L=0;           //Dis_L-¸ßµçÆ½¿ªÊ¼Ê±¶¨Ê±Æ÷µÄÖµ¡¢Dis_H-¸ßµãÆ½½áÊøÊ±¶¨Ê±Æ÷µÄÖµ
  38          bit HC_EN=0;                                            //³¬Éù²¨×´Ì¬±êÖ¾Î»-±êÖ¾³¬Éù²¨²¨ÐÎ¸ßµÍµãÆ½×´Ì¬:1´ú±í¸ßµçÆ½
  39          unsigned int HC_counter=0;                      //³¬Éù²¨´úºÅ:0~3·Ö±ð±íÊ¾ËÄ¸ö³¬Éù²¨
  40          unsigned int distance[4]=30000;         //Ç°·½ÕÏ°­Îï¾àÀë´æ·ÅÊý×é,30000ÎªÒç³öÖµ(×î´ó¼ì²â¾àÀë)(²¢Ã»ÓÐÕæÕý¼ÆËã¾àÀë,Ö
             -»ÊÇÓÃ¸ßµçÆ½µÄ¶¨Ê±Æ÷¼ÇÂ¼Öµ±íÊ¾¾àÀë¼´¿É)
  41          
  42          
  43          /*
  44          * ³¬Éù²¨Æô¶¯Âö³å£¬10us×óÓÒ
  45          * _nop_()°üº¬ÔÚintrins.hÖÐ  1¸ö»úÐµÖÜÆÚ=12¸öÊ±ÖÓÖÜÆÚ   t=12*(1/f)
  46          * 12MHz ¾§Õñ¸ÕºÃÎª1us     
C51 COMPILER V9.01   HCSR04                                                                09/28/2019 21:24:15 PAGE 2   

  47          */
  48          void HC_delay(void)                                     //³¬Éù²¨Æô¶¯Âö³å£¬10us×óÓÒ
  49          {
  50   1              _nop_(); _nop_(); 
  51   1          _nop_(); _nop_(); 
  52   1          _nop_(); _nop_(); 
  53   1          _nop_(); _nop_(); 
  54   1          _nop_(); _nop_(); 
  55   1              _nop_(); _nop_(); 
  56   1          _nop_(); _nop_(); 
  57   1          _nop_(); _nop_();
  58   1              _nop_(); _nop_(); 
  59   1          _nop_(); _nop_(); 
  60   1      }
  61          
  62          void INT0_Init()
  63          {
  64   1              IT0=1;                  //Íâ²¿ÖÐ¶Ï0ÉèÖÃÎªÏÂ½µÑØ´¥·¢(ÏÂ½µÑØ´¥·¢ºÜÖØÒª,ÒòÎªµ±³¬Éù²¨¸ßµçÆ½µÄÊ±¼ä¾ö¶¨ÁËÎïÌåµÄ¾àÀëÔ¶½ü,ÏÂ½µÑØ
             -È»ºó¼ÇÂ¼Dis_HµÄÖµÊÇ¸ßµçÆ½½áÊøµÄÖµ)
  65   1              EX0=1;                  //Íâ²¿ÖÐ¶Ï0Ê¹ÄÜ
  66   1              PX0=0;                  //½«Íâ²¿ÖÐ¶Ï0¶¨ÒåÎªµÍÓÅÏÈ¼¶
  67   1      }
  68          
  69          void InitTimer0(void)
  70          {
  71   1              TMOD |= 0x01;   //¶¨Ê±·½Ê½¼Ä´æÆ÷:ÓÃ¶¨Ê±Æ÷0µÄ·½Ê½1(16Î»¶¨Ê±Æ÷)
  72   1              TH0 = 0xDC;             //11.0592M¾§ÕñÊÇ10ms Òç³öºóTF1Î»±»ÖÃ1²¢ÇÒÉêÇëÖÐ¶Ï,½øÈëÖÐ¶ÏºóÓ²¼þ×Ô¶¯ÇåÁã
  73   1              TL0 = 0x00;     
  74   1              EA = 1;                 
  75   1              ET0 = 1;                //¶¨Ê±Æ÷0Ê¹ÄÜ
  76   1              TR0 = 1;                //ÖÃ1:Æô¶¯¶¨Ê±Æ÷1       
  77   1              PT0 = 0;                //½«¶¨Ê±Æ÷0ÖÐ¶Ï¶¨ÒåÎªµÍÓÅÏÈ¼¶ÖÐ¶Ï
  78   1      }
  79          /*
  80          *       Ã¿10msÒç³öÒ»´Î,Ö´ÐÐÒ»´Î¶¨Ê±Æ÷0µÄÖÐ¶Ïº¯Êý
  81          *       º¯Êý¹¦ÄÜ:
  82          *               ÓÃHC_counter±íÊ¾²Ù×÷µÄÊÇµÚ¼¸¸ö³¬Éù²¨(0 1 2 3)
  83          *               ²¢Ö´ÐÐHC_startº¯Êý      
  84          */
  85          void Timer0Interrupt(void) interrupt 1
  86          {
  87   1              TH0 = 0xDC;
  88   1              TL0 = 0x00;
  89   1              HC_counter++;
  90   1              if(HC_counter>3)
  91   1                      HC_counter=0;
  92   1              HC_start(HC_counter);
  93   1      }
  94          
  95          
  96          
  97          /*
  98          *       ³¬Éù²¨²¨ÐÎÍ¨¹ý»òÃÅÍ³Ò»½»¸øP3^2Íâ²¿ÖÐ¶Ï0,´¥·¢ÖÐ¶Ï·þÎñº¯Êý
  99          *       º¯Êý¹¦ÄÜ:
 100          *               ¼ÆËã³¬Éù²¨¼ì²âµ½µÄÎïÌå¾àÀë      
 101          */
 102          int flag =0;
 103          void INT_0() interrupt 0
 104          {
 105   1              EX0=0;                          //½øÀ´ÏÈ¹Ø±ÕÍâ²¿ÖÐ¶Ï0,·ñÔò¿ÉÄÜÔì³É¶þ´Î´¥·¢ÖÐ¶Ï
 106   1              Dis_H = TH0 << 8;               
 107   1              Dis_H += TL0;           //µÚ¶þ´Î¶¨Ê±Æ÷Öµ¼ÇÂ¼(¸ßµçÆ½ÏÂ½µÑØÊ±¼ÇÂ¼),µÚÒ»´ÎÊÇÔÚ¸ßµçÆ½ÉÏÉýÑØÊ±¼ÇÂ¼
C51 COMPILER V9.01   HCSR04                                                                09/28/2019 21:24:15 PAGE 3   

 108   1              _nop_(); 
 109   1              _nop_(); 
 110   1              _nop_();
 111   1              //¶þ´ÎÅÐ¶ÏP2µÄ¸ßËÄ¸öÒý½Å(ÅÐ¶Ï³¬Éù²¨²¨ÐÎµÄËÄ¸öÒý½Å)ÊÇ·ñÎª¸ßµçÆ½,Èç¹û²»ÊÇËµÃ÷Îó²Ù×÷ÁË,Ö±½ÓÍË³ö
 112   1              //Èç¹û¾­³£Îó²Ù×÷¼Ó´ó´Ë´¦µÄÑÓÊ±Ê±¼ä
 113   1              if(P2&0xf0) {
 114   2                      EX0=1;
 115   2                      return;
 116   2              }
 117   1              //³¬Éù²¨²¨ÐÎ¸ßµçÆ½Ê±¼äÖ»¼ÇÂ¼ÁË²»µ½200¸öÊý,Ê±¼äÌ«¶ÌÈÏÎªÊÇÒì³£,²»½øÐÐ²Ù×÷
 118   1              //´óÓÚ200²Å±»ÈÏÎªÊÇÕý³£µÄ½ÓÊÕµ½ÁË³¬Éù²¨¸ßµçÆ½,HC_EN==1±íÊ¾³¬Éù²¨Îª¸ßµçÆ½
 119   1              if(HC_EN && (Dis_H - Dis_L) > 200)      
 120   1              {
 121   2                      //¶þ´ÎÅÐ¶Ï³¬Éù²¨ÊÇ·ñÎª¸ßµçÆ½
 122   2                      if(HC_EN)
 123   2                      {       
 124   3                              //ÉÏÉýÑØºÍÏÂ½µÑØÁ½´Î¼ÇÂ¼µÄÖµ×÷²îµÄÖµ±íÊ¾¾àÀë
 125   3                              distance[HC_counter]=(Dis_H - Dis_L);
 126   3                              HC_EN=0;
 127   3                      }
 128   2                      else
 129   2                      {
 130   3                              distance[HC_counter]=30000;
 131   3                      }
 132   2                      /*³¬Éù²¨µ÷ÊÔÇø
 133   2                      if(distance[HC_counter]<DISTANCE)
 134   2                      printf("%d:%d\n",HC_counter,distance[HC_counter]);
 135   2                      */
 136   2                      if (flag > 30) {
 137   3                              flag = 0;
 138   3                      }
 139   2                      
 140   2                      LED = ~LED;
 141   2              }
 142   1      }
 143          
 144          
 145          /*
 146          * Í¨¹ý¶¨Ê±Æ÷ n  ´Ó0µ½3
 147          * ·¢ËÍ´¥·¢ÐÅºÅ ½ÓÊÕµ½ÏÂ½µÑØ¼ÇÂ¼Öµ  
 148          */
 149          void HC_start(unsigned char n)    
 150          {
 151   1              unsigned int i=500;             //µÈ´ý³¬Éù²¨¸ßµçÆ½³¬Ê±Ê±¼ä
 152   1              EX0=0;                                          //¹Ø±ÕÍâ²¿ÖÐ¶Ï0,µ±ÎÒÒÑ¾­¼ì²âµ½¸ßµçÆ½ºóÔÙ¿ªÆôÍâ²¿ÖÐ¶Ï0,´Ó¶øÏÂ½µÑØ´¥·¢
 153   1              if(P2&0xf0)                                     //ÓÐ³¬Éù²¨ÊÇ¸ßµçÆ½±íÊ¾ÉÏ´ÎµÄ¾àÀëÌ«Ô¶ÁË,³¬³öÁË×î´ó¼ì²â¾àÀë
 154   1              {
 155   2                      if(Echo1)distance[0]=30000;     //Òç³öÖµ
 156   2                      if(Echo2)distance[1]=30000;
 157   2                      if(Echo3)distance[2]=30000;
 158   2                      if(Echo4)distance[3]=30000;
 159   2                      P2&=0x0f;                                       //Ç¿ÐÐÀ­µÍ³¬Éù²¨EchoÒý½Å
 160   2              }
 161   1      
 162   1              switch(n)
 163   1              {
 164   2                      case 0: 
 165   2                              Echo1=1;
 166   2                              Triq1=1;
 167   2                              HC_delay();       //Í¨¹ýTriq1Òý½Å´¥·¢³¬Éù²¨Ä£¿é²â¾à
 168   2                              Triq1=0;
 169   2                              break;
C51 COMPILER V9.01   HCSR04                                                                09/28/2019 21:24:15 PAGE 4   

 170   2                      case 1:
 171   2                              Echo2=1;
 172   2                              Triq2=1;
 173   2                              HC_delay();
 174   2                              Triq2=0;
 175   2                              break;
 176   2                      case 2:
 177   2                              Echo3=1;
 178   2                              Triq3=1;
 179   2                              HC_delay();
 180   2                              Triq3=0;
 181   2                              break;
 182   2                      case 3:
 183   2                              Echo4=1;
 184   2                              Triq4=1;
 185   2                              HC_delay();
 186   2                              Triq4=0;
 187   2                              break;
 188   2                      default:break;          
 189   2              }       
 190   1              _nop_(); 
 191   1      
 192   1      
 193   1              //´¥·¢²â¾àºó,µÈ´ý³¬Éù²¨±êÖ¾Î»Ê¹ÄÜ(³¬Éù²¨²¨ÐÎ±äÎª¸ßµçÆ½)
 194   1              //ÍË³öÑ­»·Ê±Èç¹ûi==0ËµÃ÷Î´µÈ´ý³É¹¦,·ñÔòËµÃ÷µÈ´ýµ½ÁË¸ßµçÆ½(³¬Éù²¨¼ì²âµ½ÓÐÎïÌå) 
 195   1              while(Echo==0 && i--);
 196   1      
 197   1              if(i != 0)
 198   1              {
 199   2                      //µÈ´ýµ½ÁË¸ßµçÆ½,Ò²¾ÍÊÇ²¶×½µ½ÁËÉÏÉýÑØ,¼ÇÂ¼´ËÊ±¶¨Ê±Æ÷µÄÖµ²¢HC_EN¼ÇÂ¼Îª1±íÊ¾³¬Éù²¨²¨ÐÎÎª¸ßµçÆ½
 200   2                      //¿ªÆôÍâ²¿ÖÐ¶Ï,Íâ²¿ÖÐ¶Ï»áÔÚ¸ßµçÆ½Ìø±äÎªµÍµçÆ½µÄÊ±ºò´¥·¢ÖÐ¶Ï
 201   2                      Dis_L = TH0 << 8;
 202   2                      Dis_L += TL0;
 203   2                      HC_EN = 1;
 204   2                      EX0 =1;
 205   2              }
 206   1              else 
 207   1              {
 208   2                      //Ã»ÓÐµÈ´ýµ½¸ßµçÆ½(Î´¼ì²âµ½ÎïÌå),ÍË³ö
 209   2                      HC_EN=0;
 210   2              }       
 211   1      }
 212          
 213          
 214          
 215          
 216          
 217          
 218          
 219          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    416    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     16    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
